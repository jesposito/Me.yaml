# Me.yaml Development Docker Compose
# Usage: docker compose -f docker-compose.dev.yml up
#
# This configuration uses hash-based caching to skip unnecessary installs.
# Named volumes persist node_modules and Go modules across restarts.

services:
  backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.dev
    container_name: meyaml-backend-dev
    working_dir: /app
    volumes:
      - ./backend:/app/backend:cached
      - ./scripts:/app/scripts:cached
      - ./.air.toml:/app/.air.toml:cached
      - ./pb_data:/app/pb_data
      - go-cache:/go/pkg/mod
      - go-build-cache:/root/.cache/go-build
    ports:
      - "8090:8090"
    environment:
      - DATA_DIR=/app/pb_data
      # DEV ONLY: This key is for local development. Never use in production.
      # Production requires a unique key: openssl rand -hex 32
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-dev-only-key-do-not-use-in-production!!}
      - SEED_DATA=${SEED_DATA:-dev}  # 'dev' for dev profile, unset for no seeding
      - LOG_LEVEL=debug
    command: /app/scripts/dev-backend.sh
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/api/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s

  frontend:
    image: node:20-alpine
    container_name: meyaml-frontend-dev
    working_dir: /app
    volumes:
      - ./frontend:/app:cached
      - ./scripts:/scripts:cached
      - frontend-node-modules:/app/node_modules
    ports:
      - "5173:5173"
    environment:
      - POCKETBASE_URL=http://backend:8090
    command: sh -c "chmod +x /scripts/dev-frontend.sh && /scripts/dev-frontend.sh"
    depends_on:
      backend:
        condition: service_healthy

volumes:
  go-cache:
    name: meyaml-go-cache
  go-build-cache:
    name: meyaml-go-build-cache
  frontend-node-modules:
    name: meyaml-frontend-node-modules
