# Facet Caddy Configuration
# Single entry point that routes to internal services
# Designed for use behind reverse proxies (Cloudflare Tunnel, nginx, etc.)

:8080 {
    # =========================================================================
    # PHASE 5A: Minimal safe security headers
    # See docs/SECURITY.md for rationale and Phase 5B options
    # Ref: https://owasp.org/www-project-secure-headers/
    # =========================================================================
    header {
        # Prevent MIME type sniffing (universal, no risk)
        X-Content-Type-Options "nosniff"

        # Prevent clickjacking (will migrate to CSP frame-ancestors in Phase 5B)
        X-Frame-Options "DENY"

        # Control referrer information - safe default per OWASP
        Referrer-Policy "strict-origin-when-cross-origin"

        # Disable browser features not used by Facet
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"

        # Remove server identification
        -Server

        # INTENTIONALLY OMITTED:
        # - X-XSS-Protection: Deprecated since 2023, can cause vulnerabilities
        # - HSTS: TLS terminates at edge proxy (Cloudflare), not here
        # - COOP/COEP/CORP: Phase 5B - requires testing with frontend
        # - CSP: Phase 5B - requires report-only rollout first
    }

    # API and PocketBase routes go to backend
    handle /api/* {
        reverse_proxy localhost:8090
    }

    handle /_/* {
        # PocketBase admin - only allow if ADMIN_ENABLED=true
        @admin_disabled expression `{env.ADMIN_ENABLED} != "true"`
        respond @admin_disabled "Not Found" 404

        reverse_proxy localhost:8090
    }

    # Everything else goes to SvelteKit frontend
    handle {
        reverse_proxy localhost:3000
    }

    # Logging
    log {
        output stdout
        format console
    }
}
